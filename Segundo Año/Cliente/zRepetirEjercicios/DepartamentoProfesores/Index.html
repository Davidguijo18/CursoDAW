
<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Examen 1ª Evaluación DWEC</title>
		<style>
		
		 h3{
        color: red;
      }
			
			/* CSS para el formulario:   */
			.formProfes{
				visibility: hidden;  
				position: absolute;
				top: 20%;
				left: 20%;
				z-index:11;
				background-color: pink;
				border: 2px solid maroon;
				border-radius: 15px;
				padding: 1em;
				color: red;
			}

			.formProfes div label {
				display: block;
				margin-top: .5em;
			}
			
			.formProfes .btn {
				display: block;
				margin-top: 1em;
			}
			
			
			.ver {
				visibility: visible;  
			}
		
		
		#deptoDelProfe{
			font-family: "Lucida Console", "Courier New", monospace;
			font-size: 1.2em;
			font-weight: bold;
			color: blue;
		}
		
		</style>
		
		<script src="jsstore/jsstore.min.js"></script>
		<script src="jsstore/jsstore.worker.min.js"></script>
		<script src="DepartamentosBD.js"></script>
		<script type="text/javascript">
		BD();

		var idDepartamento;
		var controlador = 1;

		window.onload = async function (){
			mostrarDepartamentos();
			document.getElementById("btNuevoDepto").onclick = mostrarFormularioDepartamentos;
			document.getElementById("btCancelarDepto").onclick = ocultarFormularioDepartamentos;
			document.getElementById("btAnadeDepto").onclick = guardarDepartamento;
			document.getElementById("btNuevaProfe").onclick = mostrarFormularioAnadirProfesor;
			document.getElementById("btCancelar").onclick = ocultarFormularioDepartamentos;
			document.getElementById("btAnade").onclick = anadirProfesores;
		}


		//DEPARTAMENTOS	
		async function mostrarDepartamentos(){
			const departamentos = await obtenerDepartamentos();
            const tablaDepartamentos = document.getElementById("detalle_departamentos");
            tablaDepartamentos.innerHTML = "";

            departamentos.forEach(departamento => {
                const fila = document.createElement("tr");
                const atributosDepartamento = [departamento.id, departamento.nombre, departamento.descripcion];

                atributosDepartamento.forEach(atributoDepartamento => {
                    const columna = document.createElement("td");
                    columna.innerHTML = atributoDepartamento;
                    fila.appendChild(columna);
                });

                // Botón de ver profesores
                const td = document.createElement("td");
                const botonVerProfes = document.createElement("button");
                botonVerProfes.innerHTML = "Ver profesores";
                botonVerProfes.dataset.id = departamento.id;
				botonVerProfes.dataset.nombre = departamento.nombre;
                botonVerProfes.onclick = mostrarProfesores;
                td.appendChild(botonVerProfes);
                fila.appendChild(td);

                tablaDepartamentos.appendChild(fila);
            });
		}

		function mostrarFormularioDepartamentos(){
			document.getElementById("formDeptos").classList.add("ver");
			controlador = 1;
		}

		function ocultarFormularioDepartamentos(){
			document.getElementById("formDeptos").classList.remove("ver");
			document.getElementById("nombreDepto").value = "";
			document.getElementById("descripcion").value = "";
		}


		async function guardarDepartamento(e) {
			e.preventDefault();
			const nuevoDepartamento={
				nombre: document.getElementById("nombreDepto").value,
				descripcion: document.getElementById("descripcion").value
			}

			console.log("Objeto creado: ",nuevoDepartamento);

			await anadirDepartamento(nuevoDepartamento);
			ocultarFormularioDepartamentos();
			mostrarDepartamentos();
		}





		//PROFESORES
		async function mostrarProfesores(e) {
			e.preventDefault();
			const idDep = parseInt(this.dataset.id);
			const profesores = await obtenerProfesores(idDep);

			idDepartamento = this.dataset.id;
			console.log("Mostrando profesores del departamento con id: ", idDepartamento);

			const tablaProfesores = document.getElementById("detalle_profesores");
            tablaProfesores.innerHTML = "";

			document.getElementById("deptoDelProfe").innerHTML = this.dataset.nombre;

            profesores.forEach(profesor => {
                const fila = document.createElement("tr");
                const atributosProfesor = [profesor.id, profesor.dni, profesor.nombre, profesor.apellidos];

                atributosProfesor.forEach(atributoProfesor => {
                    const columna = document.createElement("td");
                    columna.innerHTML = atributoProfesor;
                    fila.appendChild(columna);
                });

                // Botón de editar y eliminar
                const tdEditar = document.createElement("td");
                const botonEditar = document.createElement("button");
                botonEditar.innerHTML = "Editar";
                botonEditar.dataset.id = profesor.id;
                //botonEditar.onclick = mostrarPersonas;
                tdEditar.appendChild(botonEditar);
                fila.appendChild(tdEditar);


				const tdEliminar = document.createElement("td");
                const botonEliminar = document.createElement("button");
                botonEliminar.innerHTML = "Eliminar";
                botonEliminar.dataset.id = profesor.id;
				botonEliminar.dataset.nombreape = profesor.nombre + " " + profesor.apellidos;
                botonEliminar.onclick = eliminarPersona;
                tdEliminar.appendChild(botonEliminar);
                fila.appendChild(tdEliminar);

                tablaProfesores.appendChild(fila);
            });
		}

		function mostrarFormularioAnadirProfesor(){
			document.getElementById("formProfes").classList.add("ver");
		}

		function ocultarFormularioAnadirProfesor(){
			document.getElementById("formProfes").classList.remove("ver");
			document.getElementById("dni").value = "";
			document.getElementById("nombre").value = "";
			document.getElementById("apellidos").value = "";
		}


		async function anadirProfesores(e) {
			e.preventDefault();
			var nuevoProfe ={
				id_departamento: parseInt(idDepartamento),
				dni: document.getElementById("dni").value,
				nombre: document.getElementById("nombre").value,
				apellidos: document.getElementById("apellidos").value
			}
			if(controlador ===1){
				await agregarProfesores(nuevoProfe);
				ocultarFormularioAnadirProfesor();
			}

			await agregarProfesores(nuevoProfe);
			ocultarFormularioAnadirProfesor();
		}

		async function eliminarPersona(e) {
			e.preventDefault();
			if(confirm("Deseas eliminar a " + this.dataset.nombreape)){
				const id = parseInt(this.dataset.id);
				await borrarPersona(id);
				mostrarProfesores();
			}
		}
		
    </script>
  </head>
  <body>
    <h1>Registro de Usuarios</h1>
    <form>
			<br>
			<button class="btn" id="btNuevoDepto" type="button">Nuevo Departamento</button> 
      <p>
      	<div id="departamentos">
      		<table border="1">
      			<thead>
      			<tr>
      				<th>ID</th>
      				<th>NOMBRE</th>
					<th>DESCRIPCION</th>
      				<th>Acción</th>
      			</tr>
      			</thead>
      			
      			<tbody id="detalle_departamentos">
      				
      			</tbody>
      			
      			
      		</table>
      	</div>
      </p>
      
			
			<div id="formDeptos" class="formProfes">
				<fieldset>
					<legend>Nuevo Departamento</legend>
					<div>
						<label for="nombreDepto">Nombre</label>
						<input type="text" id="nombreDepto" />
					</div>
					
					<div>
						<label for="descripcion">Descripcion</label>
						<textarea id="descripcion"></textarea>
					</div>
					<div class="btn">
						<button id="btAnadeDepto" type="button">Añadir </button> 
						<button id="btCancelarDepto" type="button">Cancelar </button>
					</div>
				</fieldset>
			</div>
      
      
      <br/>
			<br/>
      Tabla de Profesores. Departamento de <span id="deptoDelProfe"></span>:
			<br><br>
			<button class="btn" id="btNuevaProfe" type="button">Nueva profe</button> 
			
      <p>
      	<div id="profesores">
      		<table border="1">
      			<thead>
							<tr>
								<th>ID</th>
								<th>DNI</th>
								<th>NOMBRE</th>
								<th>APELLIDOS</th>
								<th>Editar</th>
								<th>Eliminar</th>
							</tr>
						</thead>
      			
      			<tbody id="detalle_profesores">
      				
      			</tbody>
      			
      			
      		</table>
      	</div>
      </p>
      
			
			<div id="formProfes" class="formProfes">
				<fieldset>
					<legend>Alta en el servicio</legend>
					<div>
						<label for="dni">DNI</label>
						<input type="text" id="dni" size="10" maxlength="9" />
					</div>
					<div>
						<label for="nombre">Nombre</label>
						<input type="text" id="nombre" />
					</div>
					<div>
						<label for="apellidos">Apellidos</label>
						<input type="text" id="apellidos" size="40" />
					</div>
					<div class="btn">
						<button id="btAnade" type="button" data-idprofe="-1">Añadir </button> 
						<button id="btCancelar" type="button">Cancelar </button>
					</div>
				</fieldset>
			</div>
      
    </form>

  </body>
</html>
